<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم بوت التداول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #111827; /* Dark gray background */
            color: #e5e7eb; /* Light gray text */
        }
        .stat-card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid #374151;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .signal-card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            border: 1px solid #374151;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .progress-ring {
            transition: stroke-dashoffset 0.5s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .btn-close {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-close:hover {
            background-color: #dc2626;
        }
        .status-open {
             background-color: #3b82f6; /* Blue */
             color: white;
        }
        .status-target_hit {
            background-color: #22c55e; /* Green */
            color: white;
        }
        .status-stop_loss_hit, .status-manual_close {
            background-color: #ef4444; /* Red */
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">لوحة تحكم بوت التداول</h1>
            <p class="text-gray-400 mt-2">مراقبة الأداء والصفقات في الوقت الفعلي</p>
        </header>

        <!-- قسم الإحصائيات -->
        <section id="stats-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">إجمالي الربح (USDT)</h3>
                <p id="total-profit" class="text-3xl font-bold mt-2">--.--</p>
            </div>
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">نسبة الربح</h3>
                <p id="win-rate" class="text-3xl font-bold mt-2">--.--%</p>
            </div>
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">نسبة الخسارة</h3>
                <p id="loss-rate" class="text-3xl font-bold mt-2">--.--%</p>
            </div>
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">الصفقات الرابحة / الخاسرة</h3>
                <p id="win-loss-count" class="text-3xl font-bold mt-2">-- / --</p>
            </div>
        </section>

        <!-- قسم الصفقات المفتوحة -->
        <section>
            <h2 class="text-2xl font-bold mb-4 text-white">التوصيات المفتوحة</h2>
            <div id="open-signals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- سيتم ملء البطاقات هنا بواسطة JavaScript -->
                 <p id="no-open-signals" class="text-gray-400 col-span-full">لا توجد صفقات مفتوحة حالياً...</p>
            </div>
        </section>
        
        <!-- قسم سجل الصفقات -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold mb-4 text-white">سجل التوصيات</h2>
            <div class="overflow-x-auto bg-[#1f2937] rounded-lg p-4">
                <table class="w-full text-right">
                    <thead class="border-b-2 border-gray-500">
                        <tr>
                            <th class="p-2">العملة</th>
                            <th class="p-2">الحالة</th>
                            <th class="p-2">سعر الدخول</th>
                            <th class="p-2">سعر الإغلاق</th>
                            <th class="p-2">الربح (%)</th>
                            <th class="p-2">وقت الإغلاق</th>
                        </tr>
                    </thead>
                    <tbody id="closed-signals-tbody">
                        <!-- سيتم ملء الصفوف هنا -->
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        const API_BASE_URL = window.location.origin;

        function createProgressRing(percentage, radius = 40) {
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100 * circumference);
            return `
                <svg class="w-24 h-24">
                    <circle class="text-gray-600" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50%" cy="50%"/>
                    <circle class="progress-ring text-blue-500"
                        stroke-width="8"
                        stroke-dasharray="${circumference} ${circumference}"
                        style="stroke-dashoffset: ${offset}"
                        stroke="currentColor"
                        fill="transparent"
                        r="${radius}"
                        cx="50%"
                        cy="50%"/>
                    <text x="50%" y="50%" text-anchor="middle" dy=".3em" class="text-lg font-bold fill-current text-white">${percentage.toFixed(1)}%</text>
                </svg>
            `;
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }
                const stats = await response.json();

                // --- تم الإصلاح: التحقق من وجود البيانات قبل عرضها ---
                document.getElementById('total-profit').textContent = stats.hasOwnProperty('total_profit_usdt') ? `${stats.total_profit_usdt.toFixed(2)}` : '--.--';
                document.getElementById('win-rate').textContent = stats.hasOwnProperty('win_rate') ? `${stats.win_rate.toFixed(2)}%` : '--.--%';
                document.getElementById('loss-rate').textContent = stats.hasOwnProperty('loss_rate') ? `${stats.loss_rate.toFixed(2)}%` : '--.--%';
                document.getElementById('win-loss-count').textContent = (stats.hasOwnProperty('wins') && stats.hasOwnProperty('losses')) ? `${stats.wins} / ${stats.losses}` : '-- / --';

            } catch (error) {
                console.error("Failed to fetch stats:", error);
                // إعادة تعيين الحقول إلى الحالة الافتراضية عند حدوث خطأ
                document.getElementById('total-profit').textContent = '--.--';
                document.getElementById('win-rate').textContent = '--.--%';
                document.getElementById('loss-rate').textContent = '--.--%';
                document.getElementById('win-loss-count').textContent = '-- / --';
            }
        }

        async function fetchSignalsAndPrices() {
            try {
                const [signalsResponse, pricesResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/signals`),
                    fetch(`${API_BASE_URL}/api/prices`)
                ]);

                const signals = await signalsResponse.json();
                const prices = await pricesResponse.json();

                const openSignalsContainer = document.getElementById('open-signals-container');
                const closedSignalsTbody = document.getElementById('closed-signals-tbody');
                const noOpenSignalsMsg = document.getElementById('no-open-signals');
                
                // --- تم الإصلاح: إخفاء رسالة "لا توجد صفقات" قبل البدء ---
                if (noOpenSignalsMsg) noOpenSignalsMsg.style.display = 'none';
                openSignalsContainer.innerHTML = '';
                closedSignalsTbody.innerHTML = '';
                let openSignalsCount = 0;

                signals.forEach(s => {
                    if (s.status === 'open') {
                        openSignalsCount++;
                        const currentPrice = prices[s.symbol] || s.entry_price;
                        
                        let progress_percentage = 0;
                        if (currentPrice > s.entry_price) {
                            progress_percentage = ((currentPrice - s.entry_price) / (s.target_price - s.entry_price)) * 100;
                        }
                        progress_percentage = Math.max(0, Math.min(100, progress_percentage));

                        const card = document.createElement('div');
                        card.className = 'signal-card flex flex-col items-center';
                        card.id = `signal-${s.id}`;
                        card.innerHTML = `
                            <h4 class="text-xl font-bold mb-2">${s.symbol}</h4>
                            <div class="my-4">${createProgressRing(progress_percentage)}</div>
                            <div class="w-full text-sm">
                                <div class="flex justify-between py-1 border-b border-gray-700"><span>السعر الحالي:</span> <strong id="price-${s.symbol}">${currentPrice.toFixed(5)}</strong></div>
                                <div class="flex justify-between py-1 border-b border-gray-700"><span>سعر الدخول:</span> <strong>${s.entry_price.toFixed(5)}</strong></div>
                                <div class="flex justify-between py-1 text-green-400"><span>الهدف:</span> <strong>${s.target_price.toFixed(5)}</strong></div>
                                <div class="flex justify-between py-1 text-red-400"><span>وقف الخسارة:</span> <strong>${s.stop_loss.toFixed(5)}</strong></div>
                            </div>
                            <button onclick="closeSignal(${s.id})" class="btn-close mt-4 w-full">خروج فوري</button>
                        `;
                        openSignalsContainer.appendChild(card);
                    } else {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-700 hover:bg-gray-700';
                        row.innerHTML = `
                            <td class="p-2 font-bold">${s.symbol}</td>
                            <td class="p-2"><span class="px-2 py-1 rounded-full text-xs font-bold status-${s.status}">${s.status.replace(/_/g, ' ')}</span></td>
                            <td class="p-2">${s.entry_price.toFixed(5)}</td>
                            <td class="p-2">${s.closing_price ? s.closing_price.toFixed(5) : 'N/A'}</td>
                            <td class="p-2 ${s.profit_percentage >= 0 ? 'text-green-400' : 'text-red-400'}">${s.profit_percentage ? s.profit_percentage.toFixed(2) + '%' : 'N/A'}</td>
                            <td class="p-2 text-xs">${new Date(s.closed_at).toLocaleString('ar-EG')}</td>
                        `;
                        closedSignalsTbody.appendChild(row);
                    }
                });
                
                // --- تم الإصلاح: إعادة إضافة الرسالة فقط إذا لم تكن هناك صفقات مفتوحة ---
                if (openSignalsCount === 0) {
                    openSignalsContainer.innerHTML = '<p id="no-open-signals" class="text-gray-400 col-span-full">لا توجد صفقات مفتوحة حالياً...</p>';
                }


            } catch (error) {
                console.error("Failed to fetch signals or prices:", error);
            }
        }
        
        async function closeSignal(signalId) {
            // --- تم الإصلاح: استخدام نافذة تأكيد مخصصة وأفضل ---
            if (!window.confirm("هل أنت متأكد من رغبتك في إغلاق هذه الصفقة يدوياً؟")) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/close/${signalId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to close signal');
                }
                alert("تم إرسال أمر الإغلاق بنجاح.");
                // Refresh data immediately
                fetchStats();
                fetchSignalsAndPrices();
            } catch (error) {
                console.error("Error closing signal:", error);
                alert(`فشل إغلاق الصفقة: ${error.message}`);
            }
        }

        // أول تحميل للبيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            fetchStats();
            fetchSignalsAndPrices();

            // تحديث البيانات كل 5 ثوانٍ
            setInterval(() => {
                // لا نحدث الإحصائيات بنفس سرعة الأسعار
                fetchSignalsAndPrices();
            }, 5000);
            
             setInterval(() => {
                fetchStats();
            }, 30000); // تحديث الإحصائيات كل 30 ثانية يكفي
        });
    </script>
</body>
</html>
