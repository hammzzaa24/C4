<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم بوت التداول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #111827; /* Dark gray background */
            color: #e5e7eb; /* Light gray text */
        }
        .stat-card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid #374151;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .signal-card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            border: 1px solid #374151;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .progress-ring {
            transition: stroke-dashoffset 0.5s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .btn-close {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-close:hover {
            background-color: #dc2626;
        }
        .status-open { background-color: #3b82f6; color: white; }
        .status-target_hit { background-color: #22c55e; color: white; }
        .status-stop_loss_hit, .status-manual_close { background-color: #ef4444; color: white; }

        /* --- New styles for market status --- */
        .gauge-bar {
            background-color: #374151;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 20px;
        }
        .gauge-fill {
            height: 100%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">لوحة تحكم بوت التداول</h1>
            <p class="text-gray-400 mt-2">مراقبة الأداء والصفقات في الوقت الفعلي</p>
        </header>

        <!-- قسم حالة السوق (جديد) -->
        <section id="market-status-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- بطاقة الاتجاه العام للسوق -->
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">الاتجاه العام للسوق (BTC)</h3>
                <div id="market-trend-content" class="flex items-center justify-center mt-4 text-2xl font-bold">
                    <span class="text-gray-500">جاري التحميل...</span>
                </div>
                 <p id="market-trend-details" class="text-center text-sm text-gray-500 mt-2 h-5"></p>
            </div>
            <!-- بطاقة مؤشر الخوف والطمع -->
            <div class="stat-card">
                 <h3 class="text-lg font-bold text-gray-400">مؤشر الخوف والطمع</h3>
                 <div id="fear-greed-content" class="mt-4">
                     <div class="flex justify-between items-center mb-2">
                         <span id="fear-greed-text" class="text-xl font-bold">...</span>
                         <span id="fear-greed-value" class="text-2xl font-bold">--</span>
                     </div>
                     <div class="gauge-bar">
                         <div id="fear-greed-gauge" class="gauge-fill" style="width: 0%;"></div>
                     </div>
                 </div>
            </div>
        </section>


        <!-- قسم الإحصائيات -->
        <section id="stats-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">إجمالي الربح (USDT)</h3>
                <p id="total-profit" class="text-3xl font-bold mt-2">--.--</p>
            </div>
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">نسبة الربح</h3>
                <p id="win-rate" class="text-3xl font-bold mt-2">--.--%</p>
            </div>
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">نسبة الخسارة</h3>
                <p id="loss-rate" class="text-3xl font-bold mt-2">--.--%</p>
            </div>
            <div class="stat-card">
                <h3 class="text-lg font-bold text-gray-400">الصفقات الرابحة / الخاسرة</h3>
                <p id="win-loss-count" class="text-3xl font-bold mt-2">-- / --</p>
            </div>
        </section>

        <!-- قسم الصفقات المفتوحة -->
        <section>
            <h2 class="text-2xl font-bold mb-4 text-white">التوصيات المفتوحة</h2>
            <div id="open-signals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="no-open-signals" class="text-gray-400 col-span-full">لا توجد صفقات مفتوحة حالياً...</p>
            </div>
        </section>
        
        <!-- قسم سجل الصفقات -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold mb-4 text-white">سجل التوصيات</h2>
            <div class="overflow-x-auto bg-[#1f2937] rounded-lg p-4">
                <table class="w-full text-right">
                    <thead class="border-b-2 border-gray-500">
                        <tr>
                            <th class="p-2">العملة</th>
                            <th class="p-2">الحالة</th>
                            <th class="p-2">سعر الدخول</th>
                            <th class="p-2">سعر الإغلاق</th>
                            <th class="p-2">الربح (%)</th>
                            <th class="p-2">وقت الإغلاق</th>
                        </tr>
                    </thead>
                    <tbody id="closed-signals-tbody"></tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        const API_BASE_URL = window.location.origin;

        // --- CHANGE: Helper function to format date in YYYY-MM-DD HH:MM format ---
        function formatEnglishDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function createProgressRing(percentage, radius = 40) {
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100 * circumference);
            // --- CHANGE: Added style="direction: ltr;" to SVG text for correct number display ---
            return `
                <svg class="w-24 h-24">
                    <circle class="text-gray-600" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50%" cy="50%"/>
                    <circle class="progress-ring text-blue-500"
                        stroke-width="8"
                        stroke-dasharray="${circumference} ${circumference}"
                        style="stroke-dashoffset: ${offset}"
                        stroke="currentColor"
                        fill="transparent"
                        r="${radius}"
                        cx="50%"
                        cy="50%"/>
                    <text x="50%" y="50%" text-anchor="middle" dy=".3em" class="text-lg font-bold fill-current text-white" style="direction: ltr;">${percentage.toFixed(1)}%</text>
                </svg>
            `;
        }
        
        async function fetchMarketStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/market_status`);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();

                // Update Market Trend
                const trendContent = document.getElementById('market-trend-content');
                const trendDetails = document.getElementById('market-trend-details');
                if (data.btc_trend) {
                    const trend = data.btc_trend;
                    if (trend.status === "Uptrend") {
                        trendContent.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                            </svg>
                            <span>صاعد</span>
                        `;
                        trendContent.className = 'flex items-center justify-center mt-4 text-2xl font-bold text-green-500';
                    } else if (trend.status === "Downtrend") {
                         trendContent.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17l5-5m0 0l-5-5m5 5H6" />
                            </svg>
                            <span>هابط</span>
                        `;
                        trendContent.className = 'flex items-center justify-center mt-4 text-2xl font-bold text-red-500';
                    }
                    trendDetails.textContent = trend.message || '';
                }

                // Update Fear & Greed Index
                const greed = data.fear_and_greed;
                if (greed && greed.value !== -1) {
                    const value = greed.value;
                    // --- CHANGE: Added span with dir="ltr" for correct number display ---
                    document.getElementById('fear-greed-value').innerHTML = `<span dir="ltr">${value}</span>`;
                    document.getElementById('fear-greed-text').textContent = greed.classification; // This is now pre-translated
                    const gauge = document.getElementById('fear-greed-gauge');
                    gauge.style.width = `${value}%`;

                    // Dynamic color for gauge
                    if (value <= 20) gauge.style.backgroundColor = '#ef4444'; // Red
                    else if (value <= 40) gauge.style.backgroundColor = '#f97316'; // Orange
                    else if (value <= 60) gauge.style.backgroundColor = '#eab308'; // Yellow
                    else if (value <= 80) gauge.style.backgroundColor = '#84cc16'; // Lime
                    else gauge.style.backgroundColor = '#22c55e'; // Green
                }

            } catch (error) {
                console.error("Failed to fetch market status:", error);
            }
        }


        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const stats = await response.json();
                
                // --- CHANGE: Added spans with dir="ltr" for correct number display ---
                document.getElementById('total-profit').innerHTML = stats.hasOwnProperty('total_profit_usdt') ? `<span dir="ltr">${stats.total_profit_usdt.toFixed(2)}</span>` : '--.--';
                document.getElementById('win-rate').innerHTML = stats.hasOwnProperty('win_rate') ? `<span dir="ltr">${stats.win_rate.toFixed(2)}%</span>` : '--.--%';
                document.getElementById('loss-rate').innerHTML = stats.hasOwnProperty('loss_rate') ? `<span dir="ltr">${stats.loss_rate.toFixed(2)}%</span>` : '--.--%';
                document.getElementById('win-loss-count').innerHTML = (stats.hasOwnProperty('wins') && stats.hasOwnProperty('losses')) ? `<span dir="ltr">${stats.wins} / ${stats.losses}</span>` : '-- / --';

            } catch (error) {
                console.error("Failed to fetch stats:", error);
                document.getElementById('total-profit').textContent = '--.--';
                document.getElementById('win-rate').textContent = '--.--%';
                document.getElementById('loss-rate').textContent = '--.--%';
                document.getElementById('win-loss-count').textContent = '-- / --';
            }
        }

        async function fetchSignalsAndPrices() {
            try {
                const [signalsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/signals`),
                ]);

                const signals = await signalsResponse.json();
                
                const openSignalsContainer = document.getElementById('open-signals-container');
                const closedSignalsTbody = document.getElementById('closed-signals-tbody');
                
                openSignalsContainer.innerHTML = '';
                closedSignalsTbody.innerHTML = '';
                let openSignalsCount = 0;

                signals.forEach(s => {
                    if (s.status === 'open') {
                        openSignalsCount++;
                        const currentPrice = s.current_price || s.entry_price;
                        
                        let progress_percentage = 0;
                        if (currentPrice > s.entry_price && s.target_price > s.entry_price) {
                            progress_percentage = ((currentPrice - s.entry_price) / (s.target_price - s.entry_price)) * 100;
                        }
                        progress_percentage = Math.max(0, Math.min(100, progress_percentage));

                        const card = document.createElement('div');
                        card.className = 'signal-card flex flex-col items-center';
                        card.id = `signal-${s.id}`;
                        // --- CHANGE: Added dir="ltr" to strong tags for correct number display ---
                        card.innerHTML = `
                            <h4 class="text-xl font-bold mb-2">${s.symbol}</h4>
                            <div class="my-4">${createProgressRing(progress_percentage)}</div>
                            <div class="w-full text-sm">
                                <div class="flex justify-between py-1 border-b border-gray-700"><span>السعر الحالي:</span> <strong id="price-${s.symbol}" dir="ltr">${currentPrice.toFixed(5)}</strong></div>
                                <div class="flex justify-between py-1 border-b border-gray-700"><span>سعر الدخول:</span> <strong dir="ltr">${s.entry_price.toFixed(5)}</strong></div>
                                <div class="flex justify-between py-1 text-green-400"><span>الهدف:</span> <strong dir="ltr">${s.target_price.toFixed(5)}</strong></div>
                                <div class="flex justify-between py-1 text-red-400"><span>وقف الخسارة:</span> <strong dir="ltr">${s.stop_loss.toFixed(5)}</strong></div>
                            </div>
                            <button onclick="closeSignal(${s.id})" class="btn-close mt-4 w-full">خروج فوري</button>
                        `;
                        openSignalsContainer.appendChild(card);
                    } else {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-700 hover:bg-gray-700';
                        const profitClass = s.profit_percentage >= 0 ? 'text-green-400' : 'text-red-400';
                        const profitSign = s.profit_percentage >= 0 ? '+' : '';
                        // --- CHANGE: Added dir="ltr" to cells and used English date format ---
                        row.innerHTML = `
                            <td class="p-2 font-bold">${s.symbol}</td>
                            <td class="p-2"><span class="px-2 py-1 rounded-full text-xs font-bold status-${s.status}">${s.status.replace(/_/g, ' ')}</span></td>
                            <td class="p-2" dir="ltr">${s.entry_price.toFixed(5)}</td>
                            <td class="p-2" dir="ltr">${s.closing_price ? s.closing_price.toFixed(5) : 'N/A'}</td>
                            <td class="p-2 ${profitClass}" dir="ltr">${s.profit_percentage ? profitSign + s.profit_percentage.toFixed(2) + '%' : 'N/A'}</td>
                            <td class="p-2 text-xs" dir="ltr">${formatEnglishDate(s.closed_at)}</td>
                        `;
                        closedSignalsTbody.appendChild(row);
                    }
                });
                
                if (openSignalsCount === 0) {
                    openSignalsContainer.innerHTML = '<p id="no-open-signals" class="text-gray-400 col-span-full">لا توجد صفقات مفتوحة حالياً...</p>';
                }

            } catch (error) {
                console.error("Failed to fetch signals or prices:", error);
            }
        }
        
        async function closeSignal(signalId) {
            if (!window.confirm("هل أنت متأكد من رغبتك في إغلاق هذه الصفقة يدوياً؟")) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/close/${signalId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to close signal');
                }
                alert("تم إرسال أمر الإغلاق بنجاح.");
                fetchStats();
                fetchSignalsAndPrices();
            } catch (error) {
                console.error("Error closing signal:", error);
                alert(`فشل إغلاق الصفقة: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchMarketStatus();
            fetchStats();
            fetchSignalsAndPrices();

            setInterval(fetchSignalsAndPrices, 5000); // تحديث الصفقات كل 5 ثوانٍ
            setInterval(fetchStats, 30000); // تحديث الإحصائيات كل 30 ثانية
            setInterval(fetchMarketStatus, 60000 * 5); // تحديث حالة السوق كل 5 دقائق
        });
    </script>
</body>
</html>
